name: Simple Laravel Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy
        env:
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_USER: ${{ secrets.SERVER_USER || 'walletdoar' }}
          SSH_PORT: ${{ secrets.SERVER_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Comando SSH base
          SSH_CMD="ssh -i ~/.ssh/deploy_key -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST"
          
          echo "ðŸš€ Iniciando deploy..."
          
          # 1. Verificar que .env existe
          $SSH_CMD "
            if [ ! -f '$DEPLOY_PATH/.env' ]; then
              echo 'âŒ ERROR: No existe .env en $DEPLOY_PATH/.env'
              echo 'Por favor, crea el archivo .env manualmente antes del deploy'
              exit 1
            fi
            echo 'âœ… .env encontrado (NO serÃ¡ modificado)'
          "
          
          # 2. Hacer git pull
          echo "ðŸ”„ Actualizando cÃ³digo..."
          $SSH_CMD "
            cd '$DEPLOY_PATH'
            git reset --hard
            git pull origin main
          "
          
          # 3. Instalar dependencias
          echo "ðŸ“¦ Instalando dependencias..."
          $SSH_CMD "
            cd '$DEPLOY_PATH'
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
          "
          
          # 4. Configurar Laravel (sin tocar .env)
          echo "âš™ï¸ Configurando Laravel..."
          $SSH_CMD "
            cd '$DEPLOY_PATH'
            
            # Asegurar enlaces simbÃ³licos
            rm -rf storage 2>/dev/null || true
            ln -nfs '$DEPLOY_PATH/shared/storage' storage 2>/dev/null || true
            
            rm -rf bootstrap/cache 2>/dev/null || true
            ln -nfs '$DEPLOY_PATH/shared/bootstrap/cache' bootstrap/cache 2>/dev/null || true
            
            # Migraciones y optimizaciÃ³n
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan storage:link
          "
          
          # 5. Permisos
          echo "ðŸ”’ Configurando permisos..."
          $SSH_CMD "
            chmod -R 775 '$DEPLOY_PATH/storage'
            chmod -R 775 '$DEPLOY_PATH/bootstrap/cache'
          "
          
          echo "âœ… Deploy completado!"
