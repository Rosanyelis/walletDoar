# =============================================================================
# Despliegue automÃ¡tico Laravel a CloudPanel (Ubuntu) al hacer push a main
# =============================================================================
#
# CONFIGURACIÃ“N EN GITHUB (Settings â†’ Secrets and variables â†’ Actions):
#   - SSH_PRIVATE_KEY: clave privada SSH del usuario walletdoar
#   - SERVER_HOST: IP o dominio del servidor (ej: 192.168.1.10 o deploy.tudominio.com)
#   - SERVER_USER: (opcional) usuario SSH; por defecto walletdoar
#   - SERVER_PORT: (opcional) puerto SSH; por defecto 22
#   - DEPLOY_PATH: ruta base en el servidor, ej: /home/walletdoar/htdocs/tudominio.com
#   - APP_ENV: (opcional) entorno de la app, por defecto production
#
# CONFIGURACIÃ“N EN EL SERVIDOR (usuario walletdoar):
#   1. Generar par de claves: ssh-keygen -t ed25519 -f deploy_key -N ""
#   2. Copiar deploy_key.pub al servidor y aÃ±adir a /home/walletdoar/.ssh/authorized_keys
#   3. En GitHub â†’ Settings â†’ Secrets: crear SSH_PRIVATE_KEY con el contenido de deploy_key
#   4. El directorio de deploy debe tener estructura:
#      /home/walletdoar/htdocs/tudominio.com/
#          â”œâ”€â”€ current -> releases/v1.0.0 (enlace simbÃ³lico)
#          â”œâ”€â”€ releases/
#          â”‚   â””â”€â”€ v1.0.0/
#          â”œâ”€â”€ shared/
#          â”‚   â”œâ”€â”€ storage/
#          â”‚   â”œâ”€â”€ .env
#          â”‚   â””â”€â”€ (otros archivos compartidos)
#          â””â”€â”€ (opcional) dploy configurado
#
# =============================================================================

name: Deploy Laravel to CloudPanel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Laravel application
    runs-on: ubuntu-latest
    
    steps:
      # Paso 1: Configurar SSH
      - name: Configurar clave SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: AÃ±adir servidor a known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      # Paso 2: Obtener informaciÃ³n del commit
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Obtener versiÃ³n del deploy
        id: version
        run: |
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "version=v${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Deploy version: v${TIMESTAMP}-${SHORT_SHA}"

      # Paso 3: Desplegar usando mÃ©todo profesional (releases + symlinks)
      - name: Desplegar con releases y enlaces simbÃ³licos
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'walletdoar' }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          APP_ENV: ${{ secrets.APP_ENV || 'production' }}
          DEPLOY_VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Validar configuraciÃ³n
          if [ -z "$DEPLOY_PATH" ]; then
            echo "âŒ ERROR: DEPLOY_PATH no configurado en GitHub Secrets"
            echo "Configura el secret DEPLOY_PATH (ej: /home/walletdoar/htdocs/tudominio.com)"
            exit 1
          fi

          # Comandos SSH con formato mejorado
          SSH_CMD="ssh -o StrictHostKeyChecking=accept-new -p $SERVER_PORT $SERVER_USER@$SERVER_HOST"

          echo "ğŸš€ Iniciando deploy versiÃ³n: $DEPLOY_VERSION"
          echo "ğŸ“ Ruta de deploy: $DEPLOY_PATH"
          echo "ğŸŒ Entorno: $APP_ENV"

          # 1. Crear estructura de directorios si no existe
          $SSH_CMD "
            # Crear estructura de directorios
            mkdir -p $DEPLOY_PATH/releases $DEPLOY_PATH/shared

            # Crear directorios compartidos necesarios para Laravel
            mkdir -p $DEPLOY_PATH/shared/storage
            mkdir -p $DEPLOY_PATH/shared/storage/app
            mkdir -p $DEPLOY_PATH/shared/storage/framework
            mkdir -p $DEPLOY_PATH/shared/storage/framework/cache
            mkdir -p $DEPLOY_PATH/shared/storage/framework/sessions
            mkdir -p $DEPLOY_PATH/shared/storage/framework/views
            mkdir -p $DEPLOY_PATH/shared/storage/logs
            mkdir -p $DEPLOY_PATH/shared/bootstrap/cache
          "

          # 2. Crear directorio de la nueva release
          RELEASE_PATH="$DEPLOY_PATH/releases/$DEPLOY_VERSION"
          echo "ğŸ“‚ Creando release en: $RELEASE_PATH"
          
          $SSH_CMD "mkdir -p $RELEASE_PATH"

          # 3. Sincronizar archivos del repositorio al servidor
          echo "ğŸ”„ Sincronizando archivos..."
          rsync -avz -e "ssh -p $SERVER_PORT -o StrictHostKeyChecking=accept-new" \
            --exclude='/.git' \
            --exclude='/.github' \
            --exclude='/node_modules' \
            --exclude='/storage' \
            --exclude='/bootstrap/cache' \
            --exclude='/.env' \
            --exclude='/.env.example' \
            --exclude='/.env.local' \
            --exclude='/deploy.php' \
            --exclude='*.log' \
            --exclude='*.sqlite' \
            ./ $SERVER_USER@$SERVER_HOST:$RELEASE_PATH/

          # 4. Configurar Laravel en el servidor
          echo "âš™ï¸ Configurando Laravel..."
          $SSH_CMD "
            cd $RELEASE_PATH

            # Enlazar archivos compartidos
            rm -rf storage && ln -nfs $DEPLOY_PATH/shared/storage storage
            rm -rf bootstrap/cache && ln -nfs $DEPLOY_PATH/shared/bootstrap/cache bootstrap/cache

            # Copiar .env si existe en shared, si no, crear uno vacÃ­o
            if [ -f $DEPLOY_PATH/shared/.env ]; then
              ln -nfs $DEPLOY_PATH/shared/.env .env
            else
              echo 'âš ï¸ ADVERTENCIA: No se encontrÃ³ .env en shared. Creando uno bÃ¡sico.'
              echo 'APP_ENV=$APP_ENV' > .env
              echo 'APP_DEBUG=false' >> .env
              echo 'APP_KEY=' >> .env
            fi

            # Configurar permisos
            chmod -R 755 storage
            chmod -R 755 bootstrap/cache
            chmod 664 .env 2>/dev/null || true

            # Establecer ownership correcto (usuario web)
            chown -R $SERVER_USER:www-data storage bootstrap/cache 2>/dev/null || true
          "

          # 5. Instalar dependencias de Composer
          echo "ğŸ“¦ Instalando dependencias de Composer..."
          $SSH_CMD "
            cd $RELEASE_PATH
            
            # Instalar dependencias sin dev y optimizando
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
            
            # Generar key si no existe
            if ! grep -q 'APP_KEY=' .env 2>/dev/null || grep -q 'APP_KEY=' .env | grep -q '^APP_KEY=$'; then
              php artisan key:generate --force
            fi
          "

          # 6. Ejecutar migraciones y optimizaciones
          echo "ğŸ”„ Ejecutando migraciones y optimizaciones..."
          $SSH_CMD "
            cd $RELEASE_PATH
            
            # Ejecutar migraciones
            php artisan migrate --force
            
            # Limpiar cache
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            
            # Cache de optimizaciÃ³n (solo en producciÃ³n)
            if [ '$APP_ENV' = 'production' ]; then
              php artisan config:cache
              php artisan route:cache
              php artisan view:cache
              php artisan event:cache
            fi
            
            # Optimizar
            php artisan optimize
            
            # Publicar assets si existen
            php artisan vendor:publish --all --force 2>/dev/null || true
            
            # Storage link
            php artisan storage:link 2>/dev/null || true
          "

          # 7. Actualizar enlace simbÃ³lico (rollout atÃ³mico)
          echo "ğŸ”— Actualizando enlace simbÃ³lico..."
          $SSH_CMD "
            cd $DEPLOY_PATH
            
            # Eliminar enlace actual si existe
            rm -f current
            
            # Crear nuevo enlace a la release
            ln -nfs releases/$DEPLOY_VERSION current
            
            echo 'âœ… Enlace actualizado a: releases/$DEPLOY_VERSION'
          "

          # 8. Limpiar releases antiguas (mantener solo las Ãºltimas 5)
          echo "ğŸ§¹ Limpiando releases antiguas..."
          $SSH_CMD "
            cd $DEPLOY_PATH/releases
            
            # Listar releases por fecha de modificaciÃ³n, mantener solo las Ãºltimas 5
            ls -1t | tail -n +6 | while read -r old_release; do
              echo 'ğŸ—‘ï¸ Eliminando release antigua: $old_release'
              rm -rf \"\$old_release\"
            done
            
            echo 'ğŸ“Š Releases actuales:'
            ls -1t
          "

          # 9. Verificar deploy
          echo "âœ… Verificando deploy..."
          $SSH_CMD "
            cd $DEPLOY_PATH/current
            
            echo 'ğŸ“Œ Ruta actual:'
            pwd -P
            
            echo 'ğŸ”— Enlace simbÃ³lico apunta a:'
            ls -la $DEPLOY_PATH/current
            
            echo 'ğŸ“‹ Estado de la aplicaciÃ³n:'
            php artisan --version
            php artisan route:list --compact 2>/dev/null | head -5 || true
          "

          echo "ğŸ‰ Â¡Deploy completado exitosamente!"
          echo "ğŸŒ VersiÃ³n desplegada: $DEPLOY_VERSION"
          echo "ğŸ“… Hora: $(date)"

      # Paso 4: NotificaciÃ³n opcional (descomentar si necesitas)
      # - name: Notificar Ã©xito
      #   if: success()
      #   run: |
      #     echo "âœ… Deploy completado exitosamente"
      #     # AquÃ­ puedes agregar notificaciones a Slack, Discord, etc.

      # - name: Notificar fallo
      #   if: failure()
      #   run: |
      #     echo "âŒ El deploy ha fallado"
      #     # Notificaciones de error

  # Job opcional para pruebas antes del deploy (descomentar si necesitas)
  # tests:
  #   name: Run tests
  #   runs-on: ubuntu-latest
  #   needs: [deploy]
  #   steps:
  #     - uses: actions/checkout@v4
  #     
  #     - name: Setup PHP
  #       uses: shivammathur/setup-php@v2
  #       with:
  #         php-version: '8.2'
  #         
  #     - name: Install dependencies
  #       run: composer install
  #       
  #     - name: Run tests
  #       run: php artisan test
