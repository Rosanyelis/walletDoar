# =============================================================================
# Despliegue optimizado Laravel a CloudPanel con releases y enlaces simbÃ³licos
# =============================================================================
#
# CONFIGURACIÃ“N EN GITHUB (Settings â†’ Secrets and variables â†’ Actions):
#   - SSH_PRIVATE_KEY: clave privada SSH del usuario walletdoar
#   - SERVER_HOST: IP o dominio del servidor
#   - SERVER_USER: (opcional) usuario SSH; por defecto walletdoar
#   - SERVER_PORT: (opcional) puerto SSH; por defecto 22
#   - DEPLOY_PATH: ruta base en el servidor, ej: /home/walletdoar/htdocs/tudominio.com
#
# CONFIGURACIÃ“N EN EL SERVIDOR:
#   1. Estructura recomendada en $DEPLOY_PATH:
#      â”œâ”€â”€ current -> releases/20250207012345_abc123 (symlink)
#      â”œâ”€â”€ releases/
#      â”‚   â””â”€â”€ 20250207012345_abc123/
#      â””â”€â”€ shared/
#          â”œâ”€â”€ storage/    (directorio compartido)
#          â”œâ”€â”€ .env        (archivo compartido, NO se toca en deploys)
#          â””â”€â”€ bootstrap/cache/
#
#   2. CloudPanel debe apuntar a: $DEPLOY_PATH/current/public
#
# =============================================================================

name: Optimized Laravel Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Laravel Application
    runs-on: ubuntu-latest
    
    steps:
      # Paso 1: Checkout del cÃ³digo
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Paso 2: Configurar SSH (mismo mÃ©todo que funciona)
      - name: Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configurar known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # Paso 3: Intentar primero con dploy (para compatibilidad)
      - name: Desplegar con dploy (CloudPanel)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'walletdoar' }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        run: |
          ssh -o StrictHostKeyChecking=accept-new \
              -p "$SERVER_PORT" \
              "$SERVER_USER@$SERVER_HOST" \
              'dploy deploy main'
        continue-on-error: true

      # Paso 4: Si dploy falla, usar mÃ©todo optimizado con releases
      - name: Desplegar con releases y symlinks (optimizado)
        if: failure()
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'walletdoar' }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Validar configuraciÃ³n
          if [ -z "$DEPLOY_PATH" ]; then
            echo "âŒ ERROR: DEPLOY_PATH no configurado en GitHub Secrets"
            echo "Configura DEPLOY_PATH (ej: /home/walletdoar/htdocs/tudominio.com)"
            exit 1
          fi

          # Generar nombre de release
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          RELEASE_NAME="${TIMESTAMP}_${COMMIT_HASH}"
          RELEASE_PATH="$DEPLOY_PATH/releases/$RELEASE_NAME"
          
          echo "ğŸš€ Iniciando deploy optimizado"
          echo "ğŸ“ Release: $RELEASE_NAME"
          echo "ğŸ“ Ruta: $RELEASE_PATH"

          # Comando SSH base
          SSH_CMD="ssh -o StrictHostKeyChecking=accept-new -p $SERVER_PORT $SERVER_USER@$SERVER_HOST"
          
          # 1. Preparar estructura en servidor
          echo "ğŸ“ Preparando estructura..."
          $SSH_CMD "
            # Crear directorios base si no existen
            mkdir -p '$DEPLOY_PATH'/releases
            mkdir -p '$DEPLOY_PATH'/shared
            mkdir -p '$DEPLOY_PATH'/shared/storage/{app,framework/{cache,sessions,views},logs}
            mkdir -p '$DEPLOY_PATH'/shared/bootstrap/cache
            
            # Verificar que existe .env en shared
            if [ ! -f '$DEPLOY_PATH/shared/.env' ]; then
              echo 'âš ï¸  ADVERTENCIA: No hay .env en $DEPLOY_PATH/shared/.env'
              echo 'Crea el archivo manualmente antes del primer deploy'
            fi
            
            # Crear directorio de release
            mkdir -p '$RELEASE_PATH'
          "

          # 2. Transferir archivos con rsync (mÃ¡s eficiente)
          echo "ğŸ“¤ Sincronizando archivos..."
          rsync -avz \
            -e "ssh -p $SERVER_PORT -o StrictHostKeyChecking=accept-new" \
            --exclude='/.git' \
            --exclude='/.github' \
            --exclude='/node_modules' \
            --exclude='/storage' \
            --exclude='/bootstrap/cache' \
            --exclude='/.env' \
            --exclude='/.env.*' \
            --exclude='*.log' \
            --exclude='*.sqlite' \
            --exclude='deploy.php' \
            --exclude='_ide_helper*' \
            --exclude='docker-compose*' \
            --progress \
            ./ \
            "$SERVER_USER@$SERVER_HOST:$RELEASE_PATH/"

          # 3. Configurar Laravel en el servidor
          echo "âš™ï¸ Configurando Laravel..."
          $SSH_CMD "
            cd '$RELEASE_PATH'
            
            # Crear enlaces simbÃ³licos a directorios compartidos
            rm -rf storage && ln -nfs '$DEPLOY_PATH/shared/storage' storage
            rm -rf bootstrap/cache && ln -nfs '$DEPLOY_PATH/shared/bootstrap/cache' bootstrap/cache
            
            # Enlazar .env desde shared (sin modificarlo)
            if [ -f '$DEPLOY_PATH/shared/.env' ]; then
              rm -f .env
              ln -nfs '$DEPLOY_PATH/shared/.env' .env
              echo 'âœ… .env enlazado desde shared (sin modificaciones)'
            else
              echo 'âŒ ERROR: No existe .env en shared. Crea $DEPLOY_PATH/shared/.env manualmente'
              exit 1
            fi
            
            # Configurar permisos bÃ¡sicos
            chmod -R 775 storage
            chmod -R 775 bootstrap/cache
            
            # Establecer ownership adecuado (usuario:www-data)
            chown -R $SERVER_USER:www-data storage bootstrap/cache 2>/dev/null || true
          "

          # 4. Instalar dependencias y optimizar
          echo "ğŸ“¦ Instalando dependencias..."
          $SSH_CMD "
            cd '$RELEASE_PATH'
            
            # Instalar Composer
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist --no-progress
            
            # Solo generar APP_KEY si no existe en .env
            if ! grep -q '^APP_KEY=base64:' '$DEPLOY_PATH/shared/.env' 2>/dev/null; then
              echo 'âš ï¸  Generando APP_KEY...'
              php artisan key:generate --force
            fi
            
            # Ejecutar migraciones
            php artisan migrate --force
            
            # Limpiar cache
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            
            # Optimizar para producciÃ³n
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Crear storage link
            php artisan storage:link
            
            echo 'âœ… Dependencias instaladas y optimizadas'
          "

          # 5. Actualizar enlace simbÃ³lico (deploy atÃ³mico)
          echo "ğŸ”— Actualizando symlink..."
          $SSH_CMD "
            cd '$DEPLOY_PATH'
            
            # Cambiar symlink de forma atÃ³mica
            ln -nfs 'releases/$RELEASE_NAME' current_tmp && mv -f current_tmp current
            
            echo 'âœ… Symlink actualizado a: releases/$RELEASE_NAME'
          "

          # 6. Limpiar releases antiguas (mantener 5 mÃ¡s recientes)
          echo "ğŸ§¹ Limpiando releases antiguas..."
          $SSH_CMD "
            cd '$DEPLOY_PATH/releases'
            
            # Contar releases y mantener solo las 5 mÃ¡s recientes
            RELEASE_COUNT=\$(ls -1t | wc -l)
            if [ \$RELEASE_COUNT -gt 5 ]; then
              ls -1t | tail -n +\$(($RELEASE_COUNT - 4)) | while read OLD_RELEASE; do
                if [ -d \"\$OLD_RELEASE\" ] && [ \"\$OLD_RELEASE\" != '$RELEASE_NAME' ]; then
                  echo 'ğŸ—‘ï¸  Eliminando: '\$OLD_RELEASE
                  rm -rf \"\$OLD_RELEASE\"
                fi
              done
            fi
            
            echo 'ğŸ“Š Releases actuales:'
            ls -1t | head -5
          "

          # 7. Verificar el deploy
          echo "âœ… Verificando deploy..."
          $SSH_CMD "
            echo '=== VERIFICACIÃ“N ==='
            echo ''
            echo 'ğŸ“Œ Ruta actual:'
            ls -la '$DEPLOY_PATH/current'
            echo ''
            echo 'ğŸ“Œ .env (verificar enlace):'
            ls -la '$DEPLOY_PATH/current/.env'
            echo ''
            echo 'ğŸ“Œ VersiÃ³n Laravel:'
            cd '$DEPLOY_PATH/current' && php artisan --version
            echo ''
            echo 'ğŸ“Œ Estado de rutas:'
            cd '$DEPLOY_PATH/current' && php artisan route:list --compact 2>/dev/null | wc -l | xargs echo 'Total rutas:'
            echo ''
            echo 'âœ… Deploy completado exitosamente'
          "

          echo "ğŸ‰ Â¡Deploy optimizado completado!"
          echo "ğŸ• Release: $RELEASE_NAME"
          echo "ğŸ“… $(date)"

      # Paso 5: VerificaciÃ³n final (siempre se ejecuta)
      - name: VerificaciÃ³n final
        if: always()
        run: |
          echo "=== RESUMEN DEL DEPLOY ==="
          echo "Hora: $(date)"
          echo "Estado: ${{ job.status }}"
          echo "=========================="
